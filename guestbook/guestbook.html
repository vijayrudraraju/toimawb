<!DOCTYPE html>
<html lang="en">
    <head>
        <title>toimawb-guestbook</title>
        <meta name="apple-mobile-web-app-capable" content="yes"/>
        <meta name="viewport" content="width=640,user-scalable=no"/>

        <meta charset="utf-8">
        <!-- Le styles -->
        <link href="http://fonts.googleapis.com/css?family=Snippet" rel="stylesheet" type="text/css">
        <link href="../lib/toimawb.css" rel="stylesheet" type="text/css">
        <style type="text/css">
            #name {
                background: rgb(105,0,0);
            }
            #post {
                background: rgb(0,105,0);
                margin-left: 20px;
            }
        </style>
    </head>
    <script type="text/javascript" src="/_utils/script/json2.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="/_utils/script/jquery.couch.js"></script>
    <script type="text/javascript" src="../vendor/underscore.js"></script>
    <script type="text/javascript" src="../vendor/backbone.js"></script>
    <script type="text/javascript" src="../vendor/backbone.localStorage.js"></script>
    <script type="text/javascript" src="../vendor/backbone-couchdb.js"></script>
    <script type="text/javascript">
        $(function() {
            window.scrollTo(0,0.9);

            Backbone.couch_connector.config.db_name = "toimawb";
            Backbone.couch_connector.config.ddoc_name = "one";

            window.BlawkModel= Backbone.Model.extend({
                url: '/guestbook'
            }); 

            window.BlawkCollection = Backbone.Collection.extend({ 
                model: BlawkModel,
                localStorage: new Store('guestbook'),
                url: "/guestbook"
            });

            window.Blawks = new BlawkCollection;

            window.AppView = Backbone.View.extend({
                color: 'red',
                tintLight: true,
                tintActive: false,
                el: $('#blawk-app'),
                events: {
                    'mousedown .button-item': 'btnDown',
                    'mouseup .button-item': 'btnUp',
                    'mousedown .clickable': 'btnDown',
                    'mouseup .clickable': 'btnUp'
                },  
                onReset: function(coll,resp) {
                    console.log('onReset');
                    console.log('coll', coll);
                    console.log('resp', resp);

                    if (coll.length === 0 && coll.localStorage.records.length === 0) {
                        console.log('local and remote mawbs empty');
                        var frames = [];
                        frames.push([]);
                        var frame = frames[0];
                        frame.push('somedata');
                        Blawks.create({frames:frames});
                    } else if (coll.length === 0) {
                        console.log('remote mawbs empty, loading local mawbs');
                        var localModel = coll.localStorage.findAll()[0];
                        Blawks.create({frames:localModel.frames});
                    } else if (coll.localStorage.records.length === 0) {
                        console.log('local mawbs empty, loading remote mawbs');
                        Blawks.at(0).sync = Backbone.localSync;
                        try {
                            Blawks.at(0).save();
                        } catch(e) {
                            //alert('Private browsing mode!');
                        }
                        delete Blawks.at(0).sync;
                    }

                    var frames = Blawks.at(0).get('frames');
                    var frame = frames[frames.length-1];
                },
                saveToServer: function(e) {
                    var frames = Blawks.at(0).get('frames');
                    frames.push([]);
                    var frame = frames[frames.length-1];
                    frame.push('somedata');

                    Blawks.at(0).set('frames',frames);

                    Blawks.at(0).save();
                },
                initialize: function() {
                    Blawks.on('reset', this.onReset, this);
                    Blawks.fetch({success: function() { console.log('fetch success');}});
                },
                btnDown: function() {
                    $('#post').css('background-color','rgb(105,105,105)');
                },
                btnUp: function() {
                    $('#post').css('background-color','rgb(0,105,0)');
                }
            });

            window.App = new AppView;

            var $el = 0;

            document.body.addEventListener('touchstart', function(e){ 
                $el = $(document.elementFromPoint(e.targetTouches[0].clientX,e.targetTouches[0].clientY));
                if ($el.hasClass('button-item') || $el.hasClass('clickable')) {
                    $('#post').css('background-color','rgb(105,105,105)');
                }
            },false);
            document.body.addEventListener('touchend', function(e){ 
                if ($el.hasClass('button-item') || $el.hasClass('clickable')) {
                    $('#post').css('background-color','rgb(0,105,0)');
                }
            },false);
        });
    </script>
    <body id="body">
        <div id="blawk-app" class="container">
            <div class="inline">
                <a class="inline" href="../"><h1 class="inline">toimawb/</h1></a>
                <h1 class="inline">guestbook/</h1>
            </div>
            <div class="canvas">
                <div id="name" class="comment-item"><h2 class="white">say hi. write anything you want. please don't make me regret this.</h2></div>
                <div id="post" class="button-item"><h2 class="white clickable">post</h2></div>
                <textarea class="input"></textarea>
            </div>
        </div>
    </body>
</html>
